#### LOAD NECESSARY PACKAGES  ####
library(dplyr)
library(sf)
library(ggplot2)
library(reshape2)
library(scales)


############################
#### VULNERABILITY DATA ####
############################

setwd('C:/Users/jenna/Desktop/VulnerabilityData/VulnerabilityData')
VulnerabilityData = data.frame(County=character(), Year=character(), Value=double(), Topic=character())

#### SOCIAL VULNERABILITY INDEX ####
SVI = read.csv('Social Vulnerability Index.csv')
SVI$Topic = 'Social Vulnerability Index'
SVI = SVI[SVI$Year == 2016,]
VulnerabilityData = rbind(VulnerabilityData, SVI)

#### No. of People Over 65 and Living Alone ####
sixtyfive = read.csv('65 yrs +, living alone.csv')
sixtyfive$Topic = 'No. of People Over 65 and Living Alone'
sixtyfive = sixtyfive[sixtyfive$Year == 2016,]
VulnerabilityData = rbind(VulnerabilityData, sixtyfive)

#### DISABILITIES #### 
disability = read.csv('No. ppl with a disability.csv')
disability$Topic = 'No. of People with a Disability'
disability = disability[disability$Year == 2016,]
VulnerabilityData = rbind(VulnerabilityData, disability)

#### FLOOD VULNERABILITY ####
floodvul = read.csv('Flood Vulnerability.csv')
floodvul$Topic = "No. of Houses in FEMA flood zones"
floodvul = floodvul[floodvul$Year == 2011,]
VulnerabilityData = rbind(VulnerabilityData, floodvul)

#### CHECKS ON DATA ####
nrow(VulnerabilityData) %% 67 # ensuring even data entries for each county (67 counties) - should always equal zero
nrow(VulnerabilityData) / 67 # indicates the number of years each county has data for
VulnerabilityData = VulnerabilityData[,-c(1,2,3,7,8)]
VulnerabilityData$County = toupper(VulnerabilityData$County)

#### FIX MIAMI-DADE ####
VulnerabilityData$County = ifelse(VulnerabilityData$County == 'MIAMI-DADE', 'DADE', VulnerabilityData$County)


#### SAVE CSV FILE ####
write.csv(VulnerabilityData,'VulnerabilityData.csv')

#### BIND TO GIS MAPS #### 
Florida.VulnerabilityData <- left_join(fl.boundary1, VulnerabilityData, by = c('COUNTYNAME' = 'County'))
Florida.VulnerabilityData.sf <- st_as_sf(Florida.VulnerabilityData)
st_write(Florida.VulnerabilityData.sf, dsn = "Florida Vulnerability", driver = "ESRI Shapefile")


#### REMOVE GIS DATA ####

Florida.VulnerabilityData = as.data.frame(Florida.VulnerabilityData)
geometry.cols = c('OBJECTID','DEPCODE','COUNTY','DATESTAMP','ShapeSTAre','ShapeSTLen',"geometry")
Florida.VulnerabilityData.noGeo <- Florida.VulnerabilityData %>% 
  select(-geometry.cols)
Florida.VulnerabilityData.noGeo = Florida.VulnerabilityData.noGeo[,-6]

write.csv(Florida.VulnerabilityData.noGeo, "non-Geo FL Vulnerability.csv")

#### "Social Vulnerability Index"
unique(Florida.VulnerabilityData.noGeo[Florida.VulnerabilityData.noGeo$Topic == 
                                         "Social Vulnerability Index",]$Year) 
# highest is 2016

#### "No. of People Over 65 and Living Alone"
unique(Florida.VulnerabilityData.noGeo[Florida.VulnerabilityData.noGeo$Topic == 
                                            "No. of People Over 65 and Living Alone",]$Year)
# highest is 2016

#### "No. of People with a Disability" 
unique(Florida.VulnerabilityData.noGeo[Florida.VulnerabilityData.noGeo$Topic == 
                                            "No. of People with a Disability",]$Year)
# highest is 2016

#### "No. of Houses in FEMA flood zones" 
unique(Florida.VulnerabilityData.noGeo[Florida.VulnerabilityData.noGeo$Topic == 
                                            "No. of Houses in FEMA flood zones",]$Year)
# highest is 2011


########  NOW SUBSET TO JUST HAVE THE MOST RECENT YEAR  #########
# take all the 2016 (highest number for each topic except the FEMA houses)
testing.FloridaVulnerability.noGeo = subset(Florida.VulnerabilityData.noGeo, Florida.VulnerabilityData.noGeo$Year == 2016)

FEMAfloodHouses = Florida.VulnerabilityData.noGeo[Florida.VulnerabilityData.noGeo$Topic == 
                                                    "No. of Houses in FEMA flood zones",]

testing.FloridaVulnerability.noGeo = rbind(testing.FloridaVulnerability.noGeo, FEMAfloodHouses)
write.csv(testing.FloridaVulnerability.noGeo, 'FloridaVulnerability.noGeo.csv')
