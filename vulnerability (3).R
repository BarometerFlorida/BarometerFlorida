#### LOAD NECESSARY PACKAGES  ####
library(dplyr)
library(sf)
library(ggplot2)
library(reshape2)
library(scales)


############################
#### VULNERABILITY DATA ####
############################

setwd('C:/Users/jennatingum/Desktop/VulnerabilityData')
VulnerabilityData = data.frame(County=character(), Year=character(), Value=double(), Topic=character())

#### SOCIAL VULNERABILITY INDEX ####
SVI = read.csv('Social Vulnerability Index.csv')
SVI$Topic = 'Social Vulnerability Index'
VulnerabilityData = rbind(VulnerabilityData, SVI)

#### OVER 65 AND LIVING ALONE ####
sixtyfive = read.csv('65 yrs +, living alone.csv')
sixtyfive$Topic = 'Over 65 and Living Alone'
VulnerabilityData = rbind(VulnerabilityData, sixtyfive)

#### DISABILITIES #### 
disability = read.csv('No. ppl with a disability.csv')
disability$Topic = 'No. of People with a Disability'
VulnerabilityData = rbind(VulnerabilityData, disability)

#### FLOOD VULNERABILITY ####
floodvul = read.csv('Flood Vulnerability.csv')
floodvul$Topic = "% of Houses in FEMA flood zones"
VulnerabilityData = rbind(VulnerabilityData, floodvul)

#### this needs to be converted to a percentage of houses
# total number of houses that each county has came from Census Fact Finder 
TotalHouses = read.csv('C:/Users/jennatingum/Desktop/housing numbers.csv', header = F)
colnames(TotalHouses) = c('County', 'No.Houses')
TotalHouses$County = toupper(TotalHouses$County)

# need to create a separate data frame with just housing data
JustHousing = VulnerabilityData[VulnerabilityData$Topic == '% of Houses in FEMA flood zones',]
JustHousing$County = toupper(JustHousing$County)

# fix dade as always
TotalHouses$County = ifelse(TotalHouses$County == "MIAMI-DADE", "DADE", TotalHouses$County)
JustHousing$County = ifelse(JustHousing$County == 'MIAMI-DADE', 'DADE', JustHousing$County)


# then merge
test = inner_join(JustHousing, TotalHouses)

test$Value = as.numeric(gsub(',', '', test$Value))
test$No.Houses = as.numeric(test$No.Houses)

test = test %>% 
  mutate(newValue = Value / No.Houses,
         newValue.perc = newValue * 100)

test$Value = test$newValue.perc

test = test %>% 
  select(-'newValue.perc',-"newValue",-"No.Houses")

test$Value = as.numeric(test$Value)


# then delete the old housing data and rbind the new calc back
newVulnerabilityData = VulnerabilityData[!VulnerabilityData$Topic == '% of Houses in FEMA flood zones',]

VulnerabilityData = rbind(newVulnerabilityData, test)


#### CHECKS ON DATA ####
nrow(VulnerabilityData) %% 67 # ensuring even data entries for each county (67 counties) - should always equal zero
nrow(VulnerabilityData) / 67 # indicates the number of years each county has data for
VulnerabilityData = VulnerabilityData[,-c(1,2,3,7,8)]
VulnerabilityData$County = toupper(VulnerabilityData$County)

#### FIX MIAMI-DADE ####
VulnerabilityData$County = ifelse(VulnerabilityData$County == 'MIAMI-DADE', 'DADE', VulnerabilityData$County)


#### SAVE CSV FILE ####
write.csv(VulnerabilityData,'VulnerabilityData.csv')

#### BIND TO GIS MAPS #### 
Florida.VulnerabilityData <- left_join(fl.boundary1, VulnerabilityData, by = c('COUNTYNAME' = 'County'))
Florida.VulnerabilityData.sf <- st_as_sf(Florida.VulnerabilityData)
st_write(Florida.VulnerabilityData.sf, dsn = "Florida Vulnerability", driver = "ESRI Shapefile")


#### REMOVE GIS DATA ####

Florida.VulnerabilityData = as.data.frame(Florida.VulnerabilityData)
geometry.cols = c('OBJECTID','DEPCODE','COUNTY','DATESTAMP','ShapeSTAre','ShapeSTLen',"geometry")
Florida.VulnerabilityData.noGeo <- Florida.VulnerabilityData %>% 
  select(-geometry.cols)
Florida.VulnerabilityData.noGeo = Florida.VulnerabilityData.noGeo[,-6]

write.csv(Florida.VulnerabilityData.noGeo, "non-Geo FL Vulnerability.csv")

#### "Social Vulnerability Index"
unique(Florida.VulnerabilityData.noGeo[Florida.VulnerabilityData.noGeo$Topic == 
                                         "Social Vulnerability Index",]$Year) 
# highest is 2016

#### "Over 65 and Living Alone"
unique(Florida.VulnerabilityData.noGeo[Florida.VulnerabilityData.noGeo$Topic == 
                                            "Over 65 and Living Alone",]$Year)
# highest is 2016

#### "No. of People with a Disability" 
unique(Florida.VulnerabilityData.noGeo[Florida.VulnerabilityData.noGeo$Topic == 
                                            "No. of People with a Disability",]$Year)
# highest is 2016

#### "% of Houses in FEMA flood zones" 
unique(Florida.VulnerabilityData.noGeo[Florida.VulnerabilityData.noGeo$Topic == 
                                            "% of Houses in FEMA flood zones",]$Year)
# highest is 2011


########  NOW SUBSET TO JUST HAVE THE MOST RECENT YEAR  #########
# take all the 2016 (highest number for each topic except the FEMA houses)
testing.FloridaVulnerability.noGeo = subset(Florida.VulnerabilityData.noGeo, Florida.VulnerabilityData.noGeo$Year == 2016)

FEMAfloodHouses = Florida.VulnerabilityData.noGeo[Florida.VulnerabilityData.noGeo$Topic == 
                                                    "% of Houses in FEMA flood zones",]

testing.FloridaVulnerability.noGeo = rbind(testing.FloridaVulnerability.noGeo, FEMAfloodHouses)
write.csv(testing.FloridaVulnerability.noGeo, 'FloridaVulnerability.noGeo.csv')
